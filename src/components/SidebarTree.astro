---
import type { TreeNode } from "@lib/notesTree";
import { normalizeSlug } from "@lib/notesTree";

type Props = {
  tree: TreeNode;
  activeSlug: string;
  basePath?: string; // mount base, should be BASE_URL
  level?: number;
};

const {
  tree,
  activeSlug,
  basePath = import.meta.env.BASE_URL,
  level = 0,
} = Astro.props;

const active = normalizeSlug(activeSlug);

// normalize base once
const base = String(basePath).replace(/\/?$/, "/");
const join = (p: string) => `${base}${String(p).replace(/^\/+/, "")}`;

function isFolderOpen(folderPrefix: string) {
  const p = normalizeSlug(folderPrefix);
  if (!p) return true;
  return active === p || active.startsWith(p + "/");
}
---
{tree.kind === "folder" ? (
  <ul class={`tree tree--level-${level}`} role={level === 0 ? "tree" : undefined}>
    {tree.children.map((node) => (
      <li class="tree__item" role="none">
        {node.kind === "folder" ? (
          <details class="tree__folder" open={isFolderOpen(node.slug)}>
            <summary class="tree__summary">
              <span class="tree__caret" aria-hidden="true"></span>
              <span class="tree__label">{node.name}</span>
            </summary>

            <Astro.self
              tree={node}
              activeSlug={activeSlug}
              basePath={basePath}
              level={level + 1}
            />
          </details>
        ) : (
          (() => {
            const noteSlug = normalizeSlug(node.slug);
            const isActive = noteSlug === active;

            // enforce trailing slash for static dir output
            const href = join(`${noteSlug}/`);

            return (
              <a
                class={`tree__link ${isActive ? "is-active" : ""}`}
                href={href}
                aria-current={isActive ? "page" : undefined}
              >
                <span class="tree__file" aria-hidden="true">â€¢</span>
                <span class="tree__label">{node.name}</span>
              </a>
            );
          })()
        )}
      </li>
    ))}
  </ul>
) : null}
