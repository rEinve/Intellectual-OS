---
import NotesLayout from "@layouts/NotesLayout.astro";
import { getCollection } from "astro:content";

const entries = await getCollection("notes");

// helpers
const titleFromSlug = (slug) => (slug.split("/").at(-1) ?? slug).replace(/-/g, " ");
const folderFromSlug = (slug) => slug.split("/").slice(0, -1).join(" / ") || "root";

// group by top folder
const groups = new Map();
for (const e of entries) {
  const top = e.slug.split("/")[0] ?? "root";
  const arr = groups.get(top) ?? [];
  arr.push(e);
  groups.set(top, arr);
}

for (const [k, arr] of groups) {
  arr.sort((a, b) => a.slug.localeCompare(b.slug));
  groups.set(k, arr);
}

const ordered = Array.from(groups.entries()).sort(([a], [b]) => {
  if (a === "daily") return -1;
  if (b === "daily") return 1;
  return a.localeCompare(b);
});

const DAILY_MAX = 14;
---

<NotesLayout>
  <div class="shelf">
  <section class="shelf__content">
    {ordered.map(([groupName, arr]) => {
      const isDaily = groupName === "daily";
      const list = isDaily ? arr.slice(-DAILY_MAX).reverse() : arr.slice(0, 24);

      return (
        <section class="shelf__group">
          <div class="shelf__groupHead">
            <h2 class="shelf__groupTitle">{groupName}</h2>
            <p class="shelf__groupMeta">{arr.length} items</p>
          </div>

          <div class="cards" role="list">
            {list.map((e) => {
              const title = e.data?.title ?? titleFromSlug(e.slug);
              const folder = folderFromSlug(e.slug);
              return (
                <a class="card" role="listitem" href={`/notes/${e.slug}`}>
                  <div class="card__title">{title}</div>
                  <div class="card__meta">{folder}</div>
                </a>
              );
            })}
          </div>
        </section>
      );
    })}
  </section>
  </div>
</NotesLayout>