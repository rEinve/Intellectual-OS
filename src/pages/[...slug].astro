---
import NotesLayout from "@layouts/NotesLayout.astro";
import WorkspaceBoard from "@components/WorkspaceBoard.astro";
import NoteView from "@components/NoteView.astro";

import { getCollection } from "astro:content";
import { WORKSPACES } from "@config/workspaces";
import {
  directChildFolders,
  entriesUnderFolder,
  isFolderSlug,
  labelFromFolderSlug,
} from "@lib/folders";

export async function getStaticPaths() {
  const entries = await getCollection("notes");

  const paths = new Set<string>();

  for (const entry of entries) {
    const parts = entry.slug.split("/");

    for (let i = 1; i <= parts.length; i++) {
      const prefix = parts.slice(0, i).join("/");
      paths.add(prefix);
    }
  }

  return Array.from(paths).map((slug) => ({
    params: { slug },   // âœ… STRING, not array
  }));
}


const slug = Astro.params.slug ?? "";
const slugParts = slug.split("/").filter(Boolean);

const workspaceKey = slugParts.length === 1 ? slugParts[0] : null;
const wsConfig = workspaceKey ? WORKSPACES[workspaceKey] ?? null : null;

const entries = await getCollection("notes");
const entry = entries.find((e) => e.slug === slug);
const folderMatch = !entry && isFolderSlug(entries, slug);

let wsEntries = [];
let subfolders = [];
let boardLabel = "";
let boardDescription: string | undefined;
let scopeKind: "Workspace" | "Folder" = "Folder";

if (folderMatch) {
  wsEntries = entriesUnderFolder(entries, slug);
  subfolders = directChildFolders(entries, slug);
  boardLabel = wsConfig?.label ?? labelFromFolderSlug(slug);
  boardDescription = wsConfig?.description;
  scopeKind = wsConfig ? "Workspace" : "Folder";
}

---

<NotesLayout>
  {entry ? (
    <NoteView entry={entry} />
  ) : folderMatch ? (
    <WorkspaceBoard
      scopeSlug={slug}
      scopeLabel={boardLabel}
      scopeKind={scopeKind}
      description={boardDescription}
      entries={wsEntries}
      subfolders={subfolders}
    />
  ) : (
    <section class="folderMissing">
      <h1>Not found</h1>
      <p>No note or folder matches <code>{slug}</code>.</p>
    </section>
  )}
</NotesLayout>
