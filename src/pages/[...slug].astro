---
import NotesLayout from "@layouts/NotesLayout.astro";
import WorkspaceBoard from "@components/WorkspaceBoard.astro";
import FolderView from "@components/FolderView.astro";
import NoteView from "@components/NoteView.astro";

import { getCollection } from "astro:content";
import { WORKSPACES } from "@config/workspaces";
import { entriesInWorkspace, directSubfolders } from "@lib/workspaceBoard";

export async function getStaticPaths() {
  const entries = await getCollection("notes");

  const paths = new Set<string>();

  for (const entry of entries) {
    const parts = entry.slug.split("/");

    for (let i = 1; i <= parts.length; i++) {
      const prefix = parts.slice(0, i).join("/");
      paths.add(prefix);
    }
  }

  return Array.from(paths).map((slug) => ({
    params: { slug },   // âœ… STRING, not array
  }));
}


const slug = Astro.params.slug ?? "";
const slugParts = slug.split("/").filter(Boolean);

const workspaceKey = slugParts.length === 1 ? slugParts[0] : null;
const wsConfig = workspaceKey ? WORKSPACES[workspaceKey] ?? null : null;

const entries = await getCollection("notes");
const entry = entries.find((e) => e.slug === slug);

let wsEntries = [];
let subfolders = [];

if (workspaceKey && wsConfig) {
  wsEntries = entriesInWorkspace(entries, workspaceKey);
  subfolders = directSubfolders(entries, workspaceKey);
}

---

<NotesLayout>
  {entry ? (
    <NoteView entry={entry} />
  ) : workspaceKey && wsConfig ? (
    <WorkspaceBoard
      workspaceKey={workspaceKey}
      workspaceLabel={wsConfig.label}
      description={wsConfig.description}
      entries={wsEntries}
      subfolders={subfolders}
    />
  ) : (
    <FolderView folderSlug={slug} />
  )}
</NotesLayout>
