---
import NotesLayout from "@layouts/NotesLayout.astro";
import NoteView from "@components/NoteView.astro";
import FolderView from "@components/FolderView.astro";
import DistillView from "@components/DistillView.astro";
import { getCollection } from "astro:content";
import { slugifyHeading } from "@lib/slugifyHeading";
import { normalizeSlug as normalize } from "@lib/normalizeSlug";



// ✅ getStaticPaths must return STRING params for [...slug]
export async function getStaticPaths() {
  const notes = await getCollection("notes");

  const notePaths = notes.map((entry) => {
    const normalized = entry.slug
      .split("/")
      .map(normalize)
      .filter(Boolean)
      .join("/");

    return {
      params: { slug: normalized },
      props: { kind: "note", key: normalized },
    };
  });

  const folderSet = new Set<string>();
  for (const entry of notes) {
    const seg0 = entry.slug.split("/")[0];
    if (seg0) folderSet.add(normalize(seg0));
  }

  const folderPaths = [...folderSet].map((folder) => ({
    params: { slug: folder },
    props: { kind: "folder", key: folder },
  }));

  // ✅ NEW: /notes/<folder>/distill
  const distillPaths = [...folderSet].map((folder) => ({
    params: { slug: `${folder}/distill` },
    props: { kind: "distill", key: `${folder}/distill` },
  }));

  return [...folderPaths, ...distillPaths, ...notePaths];
}

// -------- runtime ----------
const notes = await getCollection("notes");

const raw = Astro.params.slug ?? "";
const requested = raw.split("/").map(normalize).filter(Boolean).join("/");

const isDistill = requested.endsWith("/distill");
const folderSlug = requested.split("/")[0] ?? "";
const distillFolder = isDistill ? folderSlug : folderSlug;

// Build lookup map for note entries
const bySlug = new Map<string, any>();
for (const n of notes) {
  const key = n.slug.split("/").map(normalize).filter(Boolean).join("/");
  bySlug.set(key, n);
}

// If it's distill, we don't want to look up an entry by ".../distill"
const entry = isDistill ? null : bySlug.get(requested) ?? null;

// folder meta (for FolderView / layout context)
const folderCount = notes.filter(
  (n) => n.slug.split("/")[0] && normalize(n.slug.split("/")[0]) === distillFolder
).length;

const folder = distillFolder
  ? { slug: distillFolder, title: distillFolder, count: folderCount }
  : null;

// Determine kind
const kind = (Astro.props.kind ??
  (isDistill ? "distill" : entry ? "note" : "folder")) as "note" | "folder" | "distill";

const shouldRenderFolder = kind === "folder" || (!entry && !!folderSlug && !isDistill);
---

<NotesLayout activeSlug={requested} activeFolder={distillFolder}>
  {kind === "distill" ? (
    <DistillView folderSlug={distillFolder} notes={notes} />
  ) : shouldRenderFolder ? (
    <FolderView folder={folder} notes={notes} folderSlug={folderSlug} />
  ) : entry ? (
    <NoteView entry={entry} notes={notes} />
  ) : (
    <div class="note-empty">...</div>
  )}
</NotesLayout>
